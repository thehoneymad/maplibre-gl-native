# Using Conan.io instead of Mason
MapLibre GL Native stil uses [Mason](https://github.com/mapbox/mason), Mapbox's depcreated cross platform C/C++ package manager to resolve precompiled binaries for third party dependencies.

This document speaks towards using [conan.io](https://conan.io/) instead of Mason to resolve C/C++ precompiled binaries for third-party dependencies.

## Motivation
MapLibre GL Native was forked off Mapbox GL Native. This means for historical reasons MapLibre GL Native has dependencies maintained by Mapbox. Usage of [Mason](https://github.com/mapbox/mason) is one of them. The motivation behind replacing [Mason](https://github.com/mapbox/mason) are the following:

1. Mason is not maintained anymore by Mapbox. Since May 19, 2022, Mason is declared `unmaintained`.
2. Mason prefers static libraries over shared libraries and does not understand dependency trees. A developer is responsible to wiring dependency resolution according to the hierarchy.
3. Mapbox has been removing their open source footprint. For example, Mapbox geocoder Carmen is not available in Github anymore. This leaves a small risk of Mapbox removing Mason from Github completely. This could lead to build breakage for MapLibre and MapLibre customers.
4. Mason also brings in Mapbox maintained dependencies such as [earcut.hpp](https://github.com/mapbox/earcut.hpp) and [geojson-vt-cpp](https://github.com/mapbox/geojson-vt-cpp). At the time of writing, MapLibre does not have a fork or mirror for any of these repositories and is susceptive to the same risk mentioned above.

At the time of writing Mason is used to resolve the following dependencies:
1. earcut.hpp
2. geojson-vt-cpp
3. Boost
4. RapidJSON
5. SQLite

## Proposed Change

This document proposes the following changes:

1. MapLibre GL Native SHOULD use [conan.io](https://conan.io/) insted of [Mason](https://github.com/mapbox/mason) to resolve third party binary or header only dependencies.
2. MapLibre GL Native SHOULD use [conan.io](https://conan.io/) insted of [Mason](https://github.com/mapbox/mason) to publish and host [earcut.hpp](https://github.com/mapbox/earcut.hpp) and [geojson-vt-cpp](https://github.com/mapbox/geojson-vt-cpp). MapLibre Native GL SHOULD fork said libraries under MapLibre umbrella.

## Why Conan.io? What alternatives are out there?

In the C++ community, at the time of writing there are two front-runners for depdendency management: Conan and vcpkg. For brevity, this document does not speak of other lesser known dependency management systems.

We are starting with a comparison table for Conan.io and vcpkg. In the *Preferred Option* column this document notes the *What* and *Why* of the preference.
 
| Feature     | [conan.io](https://conan.io/)  ðŸ”µ  | [vcpkg](https://vcpkg.io/en/index.html) ðŸŸ£ |  Perferred Option |
| ----------- | ------------- | -------- | ---------------- |
| Made by | Conan.io | Microsoft | No preference. ðŸ”µðŸŸ£ |
| Platform| Linux, OSX, Windows. | Linux, OSX, Windows, Solaris, FreeBSD, embedded and cross-compiling. | vcpkg offers more platform support. ðŸŸ£ |
| Hosting | Decentralized: Artifactory, Bintray, private. Defaults to conancenter. | Centralized hosting only. | Conan.io offers more control for hosting. This keeps a two-way door open for the future. ðŸ”µ |
| Configuration Cache | Artifactory. Currently Conan hosts ~100 common configurations. |  vcpkg uses Nuget. Nuget is loved in dotnet community. But not outside. | Conan.io offers prebaked configurations for builds. ðŸ”µ |
| Build System | Cmake, MSBuild, Meson, and more. | CMake, and MSBuild. | Conan edges out vcpkgs here marginally. Although from MapLibre's perspective, only CMake is relevant. ðŸ”µ |
| Linking Type | Static and Shared. | Static and Shared. Shared linking requies extra work. | Conan marginally is better due to lesser workload. Very similar otherswise. ðŸ”µ  |
| How to add a new dependency | Conan.io uses a dedicated file named conanfile. This could be a text or a python file. | vcpkg has a manifest mode where it uses a `vcpkg.json` to list dependencies. | This is a solid tie. vcpkg `mainfest.json` is verbose but offers more control. One can define npm-esque version range for a dependency. Conan on the other hand will ask for a specific version. This document deems Conan's approach safer because it guarantees a stable build. ðŸ”µðŸŸ£ |
| Versioning| Conan.io versioning works like PIP. It uses independent versioning for all its dependencies. | vcpkgs uses independent versioning or exact versioning. | This document prefers Conan.io's exact versioning. It adds a little friction for not being able to support version ranges for a dependency. But in return we get stable builds. ðŸ”µ |
| CMakeLists.txt Usage| Automatically updates CMakeLists.txt. | Manual update to CMakeLists.txt needed for new dependency inclusion. | This is also nearly a tie. vcpkgs requirs a CMake toolchain update to wire dependencies where Conan.io requires a CMake module update. This document prefers CMake for the explicity and not having configure a CMake toolchain. ðŸ”µðŸŸ£ |
| Hosted Package Count| Conan.io hosts ~600 unique libraries. It also hosts about 100K+ known binaries. | vcpkgs hosts about 2K+ pacakges. This experience is analogous to npm. | Tie again. This does not impact MapLibre goals because the binaries MapLibre Native GL will use is available in both dependency management systems. ðŸ”µðŸŸ£ |
| Cross Compilation Experience | Conan achieves this through Conan profiles. Each platform and build system can have a dedicated profile. `conan profile` command can be used to generate a profile. | Vcpkg offers triplet files to achieve the same. But a triplet file is essentially a CMake toolchain file. Each profile build will set the CMake toolchain variable for the correct triplet file. | This document prefers Conan here because of the user experience conan profiles. ðŸ”µ |


Both of the dependency managers maintain a MIT license. Adding a missing library to both is also very similar. For conan, conancenter accepts a feature request or pull request. vcpkg also offers the same.

Both [conan.io](https://conan.io/) and [vcpkg](https://vcpkg.io/en/index.html) offers similar capability but this document favours [conan.io](https://conan.io/) because:

1. Conan profiles is better choice for cross compilation builds from an user experience point of view. MapLibre Native GL maintains a cross compiled C++ core. This fits well with facilitating that.
2. Exact versioning induces rigor. But in return we get verified MapLibre Native GL builds that works with the dependencies. This document errs on the side of stability over flexibility.

## Publishing and Integration
Publishing to conancenter or a conan repository owned by MapLibre will be achieved with Github Actions. Github Actions marketplace already offers prebaked actions for [Conan Publishing](https://github.com/marketplace/actions/conan-upload) (conan-upload). A Github repository can be used in future as [Conan Cache to speed up builds](https://github.com/marketplace/actions/conan-cache).

## Rejected Alternatives
For brevity, this document does not speak about other options such as [Buckaroo](http://www.buckaroo.pm/), [QPM](https://www.qpm.io/), [cget](https://github.com/pfultz2/cget), [Build2](https://build2.org/), [Spack](https://spack.io/), [Nuget](https://blogs.msdn.microsoft.com/vcblog/2013/04/26/nuget-for-c/), and [Hunter](https://github.com/ruslo/hunter).


## References
1. [vcpkg binary caching](https://github.com/microsoft/vcpkg/blob/master/docs/users/binarycaching.md#implementation-notes-internal-details-subject-to-change-without-notice)
2. [Conan.io package ABI compatbility](https://docs.conan.io/en/latest/creating_packages/define_abi_compatibility.html)
3. [Vcpkg vs conan for cpp](https://matgomes.com/vcpkg-vs-conan-for-cpp/)
4. [Vcpkg vs conan](https://github.com/52doho/vcpkg-vs-conan)
